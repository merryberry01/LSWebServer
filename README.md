# ls Web Server
## 과제 설명
ls 명령어를 구현하고 그 결과를 웹으로 제공하는 서버를 구현한다.

### Build
gcc -o ls_web_server ls_web_server.c -lpthread

### httpd.conf
서버의 동작을 설정하는 configuration file이다
- **MaxChilds**: 최대 자식 프로세스 수
- **MaxIdleNum**: 최대 idle 프로세스 수
- **MinIdleNum**: 최소 idle 프로세스 수
- **StartServers**: 서버 시작 시 생성되는 자식 프로세스 수
- **MaxHistory**: 기록할 수 있는 최대 연결 히스토리 수

### Preforked Server
서버는 클라이언트와 연결하기 위해 자식 프로세스를 생성한다. 하지만 클라이언트가 접속 요청을 할 때마다 생성하지 않고,
미리 몇 개의 자식 프로세스를 생성하여 클라이언트의 접속 요청을 즉시 받도록 한다.   
httpd.conf의 StartServers 필드로 설정할 수 있다.

### Whitelist
**accessible.usr** 파일을 생성하면 파일에 기록된 IP에 해당하는 클라이언트만 서버에 접속할 수 있다.   
만약 accessible.usr 파일이 존재하고 허락되지 않은 클라이언트가 접속하면 403 Error로 응답한다.

### Process Pool Management
각 프로세스는 Pid와 상태 정보를 저장하는 구조체 ProcInfo가 할당되어 있다. 또한 모든 자식 프로세스의 ProcInfo 구조체를 저장하는 메모리 풀이 존재한다.   
Idle/Busy 상태가 존재한다. 프로세스를 생성하면 초기 상태는 Idle이고,  클라이언트와 연결되면 Busy 상태로 변환된다.   
이 프로그램은 서버에서 동작하는 자식 프로세스의 수를 조절한다. 만약 idle 프로세스의 수가 MaxIdleNum, MaxChilds보다 크면 프로세스를 종료하고,
MinIdleNum보다 작으면 프로세스를 생성한다. 프로세스를 풀에 추가하거나 상태 변경 및 종료하는 스레드를 별도로 생성하여 수행한다.

### Log & Connection History
이 프로그램은 10초에 한 번씩 connection history를 출력한다. connection history에는 접속한 클라이언트 IP와 연결된 자식 프로세스의 PID, 연결된 포트, 접속 시간을 출력한다. 이 connection history는 메모리 풀에 저장된다.   
프로세스가 생성, 종료될 때마다 로그를 출력한다. 그리고 클라이언트가 접속, 접속 해제될 때마다 시간과 URL, 클라이언트 IP와 포트, 연결된 자식 프로세스의 PID, 접속 기간을 출력한다. 이 로그는 **server_log.txt**에 기록된다.


## 과제 히스토리
### 1-1
ls명령어를 구현한다. 이 버전에서 구현하는 ls 명령어는 별도의 옵션을 부여하지
않았으므로 숨긴 파일을 출력하지 않지만, 기존 ls 명령과 달리 대소문자 구별 없이 오름
차순으로 한 줄씩 출력한다. 그리고 존재하지 않는 디렉토리나 인자를 2개 이상 넘기는
경우, 혹은 디렉토리가 아닌 파일을 인자로 주는 경우 오류 메시지를 출력하도록 구현한
다. 그리고 디렉터리 엔트리 정보를 얻기 위해 라이브러리 함수 opendir(), readdir()를 이
용하며, struct dirent 필드에서 파일의 이름을 얻는다

### 1-2
이전 버전에서 구현한 ls 명령에서 -l, -a option을 추가한다. -l 옵션은 특정 경로 내에 있는 파일의 속성 정보를 출력하고,
-a옵션은 숨겨진 파일까지 출력한다. 그리고 이전에는 파일 이름을 1개만 받
도록 구현했었지만, 이번에는 여러 개의 파일 이름을 입력 받아 유효한 이름이 아닐 경
우 먼저 에러를 출력하고 나머지 유효한 파일들에 대해 출력한다.

### 1-3
ls 명령을 완성하는 과제로, 옵션 3가지와 와일드카드 기능을 추
가한다. 추가되는 옵션은 ‘r’, ‘h’, ‘S’로, r옵션은 반대로 정렬하기, h옵션은 파일 사이즈에 접
미사를 붙여 표현하기, S옵션은 정렬 기준을 사이즈로 하는 것이다. 만약 r, S 옵션을 같이
사용하면 파일 크기를 기준으로 거꾸로 정렬하되, 파일 크기가 동일하면 이름을 기준으로
거꾸로 정렬한다. 그리고 기능이 제공되는 wildcard는 ‘[]’, ‘*’, ‘?’이고, fnmatch() 함수를
이용하여 패턴에 맞는 파일들을 출력한다.

### 2-1
5개의 옵션과 wildcard 기능이 구현된 ls 프로그램의 결과가 html 문서로 출력되도록 구현한다.
따라서 이번 과제에서 표준 출력이 아닌 파일 출력을 사용한다. 또한 특정 디렉토리 내의 파일 목록을 table로 표시하기 위해서는 HTML tag인 <table>
을 사용하며, 각 파일의 종류를 확인하여 그에 맞는 색상을 적용해야 하므로 inline CSS를
사용한다. 또한 각 파일을 클릭하면 해당 경로 혹은 파일을 볼 수 있도록 hyperlink tag인
<a>를 사용하여 구현한다. 이때 출력에서 html_ls.html이 출력되지 않도록 구현한다.

### 2-2
이전 버전에서 구현한 ls 프로그램의 결과를 HTTP 웹 클라이언트에게 제공
하는 웹 서버를 구현하는 것이다. 만약 클라이언트가 디렉토리의 하위 파일 리스트를 요
청하면 서버가 이 리스트를 HTML 문서로 생성하여 클라이언트에게 제공한다. 그리고 디
렉토리가 아닌 파일을 요청하면 해당 파일 데이터를 클라이언트에게 전송하여 클라이언
트가 다운로드할 수 있도록 한다. 그러나 유효하지 않은 경로로 접근하면 404 error를 출
력한다. 클라이언트가 요청하는 경로는 HTTP Request Header에서 파악한다.

### 2-3
이전 버전에서 구현한 HTTP web server ls를 다중 접속이 가능하도록 구현한
다. 이를 위해서는 fork()를 호출하여 새로운 자식 프로세스를 생성하여, 부모 프로세스는
클라이언트로부터의 연결 요청을 받아들여 연결 성립을 하고, 자식 프로세스는 클라이언
트와 HTTP packet을 주고받는다. 또한 접근 제어 기능을 구현하여 일부 승인된 IP만 접속
이 허용하도록 한다. whitelist는 accessible.usr 문서로 관리하며, 와일드카드 ‘*’을 사용할
수 있으므로 fnmatch를 이용하면 구현에 도움이 될 것이다. 또한 10초 주기로 alarm 
signal을 설정하고, signal handler로 최근 클라이언트 접속 기록을 출력하도록 한다.

### 3-1
이번에는 accept() 호출 전에 5개의 자식 프로세스를 미리 생성하여, 이 프로세스들이 client로부터의 요청을 받는다.
또한 10초마다 history를 출력할 때, 해당 history table의 title은 부모 프로세스가 출력하고, 각 자식 프로세스의
connection log는 해당 자식 프로세스들이 부모로부터 SIGUSR1 signal을 수신하였을 때
출력하도록 구현한다.

### 3-2
부모 프로세스가 자식 프로세스들의 개수를 조절하는 preforked server을 구현하는 것이다. 
부모 프로세스는 실행 시 httpd.conf 파일을 읽어 최대 자식 프로세스의 수와 idle 프로세스의 최대/최소 수, 서버 시작 시 생성되는 자식 수
를 설정하고, 이에 따라 자식 프로세스의 수를 조절한다. 이를 위해서 부모 프로세스가
자식 프로세스들의 상태 정보를 알아야 하는데, 자식 프로세스는 shared memory를 통해
부모 프로세스에게 자신의 상태 정보를 공유한다. 마지막으로 history를 출력할 때 총 몇
개를 출력할 것인지 설정할 수 있고, history 또한 shared memory 내에서 관리된다.

### 3-3
지금까지 구현했던 프로그램에서 log file 기능을 추가한다. 이때 log file에 접근할 때는 semaphore을 사용하며, 하나의 스레드만이 해당 log 
file에 내용을 write할 수 있으므로 binary semaphore을 이용하여 구현한다. 또한 주기적
으로 출력되는 connection history는 log file에서 제외되며, client와 연결이 성립되고 끊어
질 때마다 출력되는 log에는 해당 connection을 유지하는 자식 프로세스의 pid와 client가
요청한 path를 출력한다. 특히 연결이 종료될 때에는 해당 client가 연결 성립부터 종료될
때까지 몇 microseconds간 connection을 유지했는지도 측정하여 출력한다.
